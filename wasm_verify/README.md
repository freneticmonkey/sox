# WASM Verification with Wazero

This module provides independent verification of WASM files generated by Sox using the [wazero](https://wazero.io/) WebAssembly runtime for Go.

## Purpose

The Sox interpreter can compile scripts to WebAssembly binaries (`.wasm` files). This verification module ensures that:

1. Generated WASM files are valid and spec-compliant
2. WASM modules can be loaded by a standard WebAssembly runtime
3. Execution produces expected results
4. The `env.print_f64` host function import works correctly

## Architecture

- **verify.go**: Core Go implementation using wazero runtime
- **wasm_verify.h**: C-compatible interface for integration with Sox tests
- **Makefile**: Builds Go code as a C-shared library

## Building

```bash
cd wasm_verify
make
```

This produces `../build/libwasm_verify.so` (Linux) or `../build/libwasm_verify.dylib` (macOS).

## API

### C Interface

```c
// Verify and execute a WASM file, return output as comma-separated string
int VerifyWASMFile(const char* path, char** output, char** errorMsg);

// Get WASM output as array of doubles
int GetWASMOutput(const char* path, double** output, int* count, char** errorMsg);

// Free Go-allocated strings
void FreeString(char* s);

// Free Go-allocated double arrays
void FreeDoubleArray(double* arr);
```

### Example Usage in C

```c
#include "wasm_verify/wasm_verify.h"

double* values = NULL;
int count = 0;
char* error = NULL;

if (GetWASMOutput("test.wasm", &values, &count, &error)) {
    // Success - process values
    for (int i = 0; i < count; i++) {
        printf("%f\n", values[i]);
    }
    FreeDoubleArray(values);
} else {
    // Error
    printf("Error: %s\n", error);
    FreeString(error);
}
```

## Integration with Sox Tests

The verification library is integrated into `src/test/wasm_test.c` to:

- Validate generated WASM files are loadable
- Execute WASM and capture output from `print_f64` calls
- Compare WASM execution results with expected values

## Dependencies

- Go 1.21+
- [wazero](https://github.com/tetratelabs/wazero) v1.7.0

## How It Works

1. Reads `.wasm` file from disk
2. Validates WASM magic number (`\0asm`)
3. Creates wazero runtime with WASI support
4. Registers host function `env.print_f64` to capture output
5. Instantiates and executes WASM module's `main` function
6. Returns captured output values to caller

## Supported Features

Currently supports verification of:
- Basic arithmetic operations (add, sub, mul, div)
- Constant values
- Print operations
- Local/global variables

## Limitations

WASM modules using unsupported Sox opcodes (control flow, functions, OOP features) will generate valid but non-functional WASM. The verifier will load these modules but execution may not produce meaningful results.
